import { z } from 'zod';

/**
 * Centralized schema definitions for the cricket quiz application.
 * Ensures consistent type safety and validation for core data structures.
 */

export const QuizQuestion = z.object({
  id: z.string().describe('Unique question identifier.'),
  question: z.string().describe('Text of the quiz question.'),
  options: z.array(z.string()).length(4).describe('Four distinct answer options.'),
  correctAnswer: z.string().describe('Valid correct answer string.'),
  explanation: z.string().describe('Detailed explanation of the answer.'),
});

export const QuizData = z.object({
  questions: z.array(QuizQuestion).length(5).describe('Array of exactly five quiz questions.'),
});

export const QuizAttempt = z.object({
  userId: z.string().min(1).describe("User's unique identifier."),
  slotId: z.string().describe("10-minute quiz slot ID."),
  brand: z.string().optional().default("unknown").describe("Quiz brand."),
  format: z.string().min(1).describe("Cricket format."),
  questions: z.array(QuizQuestion).min(1).describe("Questions in the quiz attempt."),
  userAnswers: z.array(z.string()).describe("User's selected answers."),
  score: z.number().int().describe("User's final score."),
  totalQuestions: z.number().int().describe("Total questions attempted."),
  timestamp: z.number().describe("Completion timestamp in ms."),
  timePerQuestion: z.optional(z.array(z.number())).describe("Time per question in seconds."),
  unanswered: z.optional(z.number().int()).describe("Number of unanswered questions."),
  reason: z.optional(z.string().nullable()).describe("Disqualification reason if any."),
  source: z.optional(z.enum(["ai", "fallback"])).describe("Data source"),
  reviewed: z.boolean().optional().default(false).describe("Whether quiz is reviewed"),
});

export const QuizAnalysisOutputSchema = z.object({
  summary: z.string().describe("A concise overall insight into the user's performance, mentioning score and format."),
  strengths: z.array(z.string()).min(1).max(3).describe("A list of 1-3 key strengths the user demonstrated."),
  weaknesses: z.array(z.string()).min(1).max(3).describe("A list of 1-3 specific areas for improvement."),
  recommendations: z.array(z.string()).min(1).max(3).describe("A list of 1-3 actionable next steps for the user."),
  source: z.enum(["ai", "fallback"]).default("fallback"),
});

// ✅ FIXED: Added Zod schema for HintOutput
export const HintOutputSchema = z.object({
  hint: z.string().describe("The hint text generated by AI or fallback."),
  source: z.enum(["ai", "fallback"]).describe("Source of the hint."),
  debug: z.string().optional().describe("Optional debug information."),
});

// ✅ Export TypeScript types (inferred from schemas)
export type QuizQuestion = z.infer<typeof QuizQuestion>;
export type QuizData = z.infer<typeof QuizData>;
export type QuizAttempt = z.infer<typeof QuizAttempt>;
export type QuizAnalysisOutput = z.infer<typeof QuizAnalysisOutputSchema>;
export type HintOutput = z.infer<typeof HintOutputSchema>;
